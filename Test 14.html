<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>สุ่มภาพ Bingo </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root
    {
      --w: 480px;   /* ความกว้างสูงสุดของกรอบแสดง/กรอบใส่รูป */
      --fade: 140ms;
      --blue: #2d5bd1;
      --blue-weak: #eaf2ff;
    }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--blue-weak); color:#111; }

    .app{ display:flex; min-height:100vh; }

    /* ===== Sidebar (pool) ===== */
    .sidebar
    {
      width: 280px; max-width: 90vw;
      background:#f7faff;
      border-right:1px solid #d6e4ff;
      padding:14px; position:relative;
      transform: translateX(0); transition: transform .25s ease;
    }
    .sidebar.hidden{ transform: translateX(-100%); }
    .sidebar .title{ font-weight:700; margin:4px 0 12px; }
    .thumb-list{ display:grid; grid-template-columns: 1fr; gap:8px; overflow:auto; max-height: calc(100vh - 240px); padding-right:4px; }
    .thumb{ display:flex; align-items:center; gap:8px; background:#f3f7ff; border:1px solid #e1eaff; border-radius:10px; padding:6px; }
    .thumb img{ width:52px; height:52px; object-fit:cover; border-radius:8px; }
    .thumb .meta{ flex:1; min-width:0; }
    .thumb .meta .name{ font-size:12px; color:#2a2f3a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .thumb .meta .size{ font-size:11px; color:#6b7280; }
    .btn-del{ border:0; background:#ff3b30; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; }

    /* ปุ่ม toggle ด้านบนซ้าย/ขวา */
    .toggle-btn, .toggle-results
    {
      position: fixed; top: 8px; z-index: 50;
      border:0; background:#111; color:#fff; padding:10px 14px;
      border-radius:10px; cursor:pointer; font-weight:700;
      box-shadow: 0 6px 16px rgba(0,0,0,.18);
    }
    .toggle-btn{ left: 8px; }
    .toggle-results{ right: 8px; }

    /* ===== Main ===== */
    .main{ flex:1; display:grid; place-items:center; padding:24px; position:relative; }
    .card
    {
      width: min(92vw, 620px);
      background:#fff;
      padding:20px;
      border-radius:16px;
      box-shadow: 0 10px 26px rgba(0,0,0,.12);
      text-align:center;

      margin-left: -200px;   /* ขยับไปทางซ้าย (ปรับค่าตามที่ต้องการ) */
      position: relative;
    }

    /* ==== กรอบแสดงภาพ: ยืดหยุ่นตามการ์ด ไม่ล้นมือถือ ==== */
    .stage
    {
      position: relative;
      width: 100%;
      max-width: var(--w);
      margin: 24px auto 26px;
      border-radius: 14px;
      overflow: hidden;
      background:#ddd; /* เทาอ่อน */
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      aspect-ratio: 16 / 10;   /* กันล้นแนวตั้งบนมือถือ */
      
    }
    .stage img
    {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:0;
      transition:opacity var(--fade) linear;
    }
    .stage img.active{ opacity:1; }

    .row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px 0; }
    button{ padding:10px 16px; border:0; border-radius:10px; cursor:pointer; background:#111; color:#fff; font-weight:700; transition: transform .06s ease, box-shadow .12s ease, background .15s linear; }
    button.secondary{ background: var(--blue); } /* เริ่ม/รีเซ็ต/Bingo */
    button.warn{ background:#9a9a9a; }          /* หยุด */
    button:disabled{ opacity:.45; cursor:not-allowed; }

    /* ไฮไลต์ปุ่มหยุดตอนกำลังสุ่ม */
    .stop-highlight{ background:#ff3b30 !important; box-shadow: 0 0 0 4px rgba(255,59,48,.15), 0 6px 16px rgba(0,0,0,.2); animation: pulse 1s infinite ease-in-out; }
    @keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.035)} 100%{transform:scale(1)} }

    .small{ font-size:12px; color:#4b5563; }
    .counter{ font-weight:700; }

    /* ==== กรอบใส่รูป + input file: ยืดตามการ์ด ไม่เกิน 480px ==== */
    .dropzone,
    input[type="file"]
    {
        width: 100%;
        max-width: var(--w);
        box-sizing: border-box;
    }
    .dropzone
    {
        margin: 8px auto 6px;
        border: 2px dashed #bcd3ff; background:#f0f6ff; color:#384152;
        padding:12px; border-radius:12px; transition: all .2s ease;
    }
    .dropzone.dragover{ border-color: var(--blue); background:#e8f0ff; color:#2348a3; transform: scale(1.01); }
    input[type="file"]{ border:1px solid #cfd4dc; border-radius:10px; padding:8px; }

    /* ปรับสีปุ่มรีเซ็ตให้เหมือนปุ่มเริ่ม + เพิ่มช่องว่างก่อน dropzone */
    #resetBtn{ background: var(--blue); }
    #resetRow{ margin-bottom: 20px; }

    /* ===== Modal (ภาพใหญ่) ตรงกลางชัวร์ ===== */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:flex; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity .2s ease; padding:16px; }
    .modal.show{ opacity:1; pointer-events:auto; }
    .dialog{ position:relative; background:#000; border-radius:14px; overflow:hidden; max-width:min(96vw,1080px); max-height:min(90vh,1080px); box-shadow:0 20px 60px rgba(0,0,0,.5); margin:auto; }
    .dialog img{ display:block; max-width:100%; max-height:calc(90vh - 56px); object-fit:contain; margin:auto; }
    .dialog .bar{ display:flex; justify-content:flex-end; gap:8px; background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)); padding:8px; position:absolute; left:0; right:0; top:0; }
    .btn-close{ background:#fff; color:#111; border:0; padding:6px 12px; border-radius:10px; cursor:pointer; font-weight:700; }

    /* ===== แผงผลด้านขวา (รูปที่หยุดได้) ===== */
    .results
    {
        position: fixed; right: 8px; top: 56px; width: 240px; max-height: 78vh;
        background:#ffffff; border:1px solid #d6e4ff; border-radius:12px; box-shadow: 0 10px 28px rgba(0,0,0,.15);
        padding:10px; display:none; z-index:60;
    }
    .results.show{ display:block; }
    .results .head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .results .head .ttl{ font-weight:800; color:#2348a3; }
    .results .list{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; overflow:auto; max-height: 66vh; }
    .results .item{ border:1px solid #e6eeff; border-radius:10px; overflow:hidden; background:#f7faff; cursor:pointer; }
    .results .item img{ width:100%; height:100%; object-fit:cover; display:block; aspect-ratio: 1/1; }
    .results .btn-clear{ background:#ff3b30; color:#fff; border:0; border-radius:8px; padding:6px 10px; font-weight:700; cursor:pointer; }
    .results .hint{ font-size:12px; color:#6b7280; }

    @media (max-width: 840px){
      .toggle-btn{ left: 8px; }
      .results{ width: 200px; }
    }

    /* เฉพาะปุ่ม Bingo */
    #bingoBtn
    {
        background: #ff3b30;   /* สีพื้นหลังที่ต้องการ */
        color: #ffffff;           /* สีตัวอักษร */
    }
        #bingoBtn:hover{ background: #ffb300; }
        #bingoBtn:active{ transform: translateY(1px); }


    /* ===== Bingo Popup (เหมือน modal, มีปุ่มปิด) ===== */
    .bingo-modal{ position:fixed; inset:0; background:rgba(0,0,0,.80); display:flex; align-items:center; justify-content:center; z-index:150; opacity:0; pointer-events:none; transition:opacity .2s ease; padding:16px; }
    .bingo-modal.show{ opacity:1; pointer-events:auto; }
    .bingo-dialog{
    position: relative;
    background: rgba(227, 232, 241, 0.9); 
    border-radius: 20px;
    padding: 32px 20px;

    width: min(95vw, 1000px);   /* <<< กว้างขึ้น */
    height: min(90vh, 420px);   /* <<< เพิ่มความสูง (vh = ตามจอ) */

    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
    overflow: hidden;

}

    .bingo-header{ display:flex; justify-content:flex-end; margin-bottom:6px; }
    .bingo-close{ background:#fff; color:#111; border:0; padding:6px 12px; border-radius:10px; font-weight:800; cursor:pointer; }

    /* ข้อความ BINGO: ให้ตัวอักษรเด้งทีละตัว */
    .bingo-text
    {
        font-family:'Luckiest Guy', cursive;   /* ฟอนต์การ์ตูนหนาแบบตัวอย่าง */
        text-align:center;
        font-size: clamp(72px, 19vw, 220px);
        font-weight:900;
        letter-spacing: 4px;
        color:#fff;                            /* สีจริงจะกำหนดรายตัวที่ .bingo-letter */
        text-shadow:
            0 2px 0 #fff, 0 -2px 0 #fff,        /* ทำขอบขาวหนา ๆ */
            -2px 0 0 #fff, 2px 0 0 #fff,
            0 8px 24px rgba(0,0,0,.35);
        -webkit-text-stroke: 6px #fff;         /* เส้นขอบขาว (รองรับกว้าง) */
        paint-order: stroke fill;
        white-space:nowrap;
        user-select:none;
    }

    /* ตัวอักษรเด้งทีละตัว + ดีเลย์ช้าลง */
    .bingo-letter
    {
        display:inline-block;
        opacity:0;
        transform: translateY(24px) scale(.92);
        animation: bingo-letter-pop .46s ease-out forwards;
        animation-delay: calc(var(--i) * 0.35s);   /* <<< ปรับความช้าได้ที่ 0.35s */
    }
    @keyframes bingo-letter-pop{
    to{ opacity:1; transform: translateY(0) scale(1); }
}

/* สีแต่ละตัวอักษรแบบภาพตัวอย่าง */
.bingo-letter:nth-child(1){ color:#00C2C7; } /* B  ฟ้าอมเขียว */
.bingo-letter:nth-child(2){ color:#FFC400; } /* I  เหลือง */
.bingo-letter:nth-child(3){ color:#2ECC71; } /* N  เขียว */
.bingo-letter:nth-child(4){ color:#1E90FF; } /* G  น้ำเงิน */
.bingo-letter:nth-child(5){ color:#FF5A36; } /* O  ส้มแดง */
.bingo-letter:nth-child(6){ color:#8E44AD; } /* !  ม่วง */

    /* กระดาษโปรย */
    .confetti
    {
        position: absolute; top: -8px;
        width: 10px; height: 14px; opacity: .9;
        transform: translateY(-100vh) rotate(0deg);
        animation: fall linear forwards, spin linear forwards;
    }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(0deg); } }
    @keyframes spin{ to{ transform: translateY(110vh) rotate(360deg); } }

button:disabled 
{
    opacity: 0.5;
    pointer-events: none; /* กดไม่ได้ */
}


  </style>
</head>
<body>

  <!--เอาเสียงเข้า-->
  <audio id="bingoSound" src="bingo.mp3" preload="auto"></audio>
  <audio id="shuffleSound" src="spinner.mp3" preload="auto" loop></audio>
  <audio id="stopSound" src="stop.mp3" preload="auto"></audio>
  
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

  <!-- ปุ่มซ้าย: รายการในพูล / ปุ่มขวา: ผลที่หยุด -->
  <button class="toggle-btn" id="toggleSidebar" type="button">☰ รูปทั้งหมด (<span id="countTop">0</span>)</button>
  <button class="toggle-results" id="toggleResults" type="button">ประวัติ (<span id="stoppedCount">0</span>)</button>

  <div class="app">
    <!-- Sidebar: รายการรูปในพูล -->
    <aside class="sidebar hidden" id="sidebar">
      <div class="title">รายการรูปที่มี (<span id="countSide">0</span>)</div>
      <div id="thumbList" class="thumb-list"></div>
      <hr style="margin:12px 0; border:none; border-top:1px solid #e1eaff;">
      <div class="small">คลิกปุ่ม “☰ รูปทั้งหมด” เพื่อซ่อน/โชว์แถบนี้</div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="card">
        <h2>BINGO</h2>

        <div class="stage" id="stage">
          <img id="layerA" alt="">
          <img id="layerB" alt="">
        </div>

        <div class="row">
          <button id="startBtn" type="button" class="secondary"> เริ่มสุ่ม </button>
          <button id="stopBtn" type="button" class="warn"> หยุดสุ่ม (ขอให้โชคดีนะจ๊ะ) </button>
          <button id="bingoBtn" type="button" class="secondary">Bingo!!!</button>
        </div>
        <div class="row" id="resetRow">
          <button id="resetBtn" type="button" class="secondary">รีเซ็ตทั้งหมด</button>
        </div>

        <div class="dropzone" id="dropzone">ลากไฟล์รูป (JPG/PNG/GIF/WebP) มาวางในกรอบนี้ หรือเลือกไฟล์ด้านล่าง</div>
        <input type="file" id="fileInput" accept="image/*" multiple />

        <div class="small" style="margin-top:10px;">
          มีรูปในพูลสุ่ม <span class="counter" id="countBottom">0</span> ไฟล์ • ลากไฟล์หรือกดเลือกไฟล์เพื่อเพิ่ม • ลบได้ในแถบด้านซ้าย • รีเซ็ต = คืนรูปที่เคยลบกลับมา
        </div>
      </div>
    </main>
  </div>

  <!-- แผงผลที่หยุด -->
  <aside class="results" id="resultsPanel" aria-label="รูปที่หยุดได้">
    <div class="head">
      <div class="ttl">ประวัติการสุ่ม</div>
      <button class="btn-clear" id="clearResults" type="button">ล้างประวัติ</button>
    </div>
    <div class="list" id="resultsList"></div>
    <div class="small"><span class="hint">คลิกรูปเพื่อขยาย</span> • รวม <b id="stoppedCount2">0</b> รูป</div>
  </aside>

  <!-- Modal รูปใหญ่ -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-label="ภาพที่หยุดสุ่มไว้">
      <div class="bar"><button class="btn-close" id="closeModal" type="button" aria-label="ปิด">ปิด</button></div>
      <img id="modalImg" alt="ภาพที่หยุดสุ่มไว้">
    </div>
  </div>

  <!-- Bingo Popup (เหมือน modal + ปุ่มปิด) -->
  <div class="bingo-modal" id="bingoModal" aria-hidden="true">
    <div class="bingo-dialog" role="dialog" aria-label="Bingo Animation">
      <div class="bingo-header">
        <button class="bingo-close" id="bingoClose" type="button">ปิด</button>
      </div>
      <!-- ปล่อยว่างไว้ ให้ JS เติมตัวอักษรเข้าไป -->
      <div class="bingo-text" id="bingoText"></div>
      <!-- confetti จะถูกสร้างแบบ dynamic ที่นี่ -->
    </div>
  </div>

    <!-- เพิ่ม wrapper สำหรับตัวอักษร -->
    <div class="bingo-content">
      <div class="bingo-text" id="bingoText"></div>
    </div>

  <script>
    // ===== State =====
    let images = [];        // pool ปัจจุบัน
    let allImages = [];     // สำเนาทั้งหมด (สำหรับรีเซ็ต)
    let stoppedImages = []; // ประวัติรูปที่หยุดได้

    // ===== DOM =====
    const layerA = document.getElementById('layerA');
    const layerB = document.getElementById('layerB');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const bingoBtn = document.getElementById("bingoBtn");
    const fileInput= document.getElementById('fileInput');

    // เมื่อกดปุ่มเริ่ม
    startBtn.addEventListener("click", () => {
    bingoBtn.disabled = true;   // ปุ่ม Bingo จางลง
    resetBtn.disabled = true;   // ปุ่ม Reset จางลง
    });

    // เมื่อกดปุ่มหยุด
    stopBtn.addEventListener("click", () => {
    bingoBtn.disabled = false;  // ปุ่ม Bingo ใช้งานได้อีกครั้ง
    resetBtn.disabled = false;  // ปุ่ม Reset ใช้งานได้อีกครั้ง
    });


    const thumbList = document.getElementById('thumbList');
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');

    const dropzone = document.getElementById('dropzone');
    const countEls = [document.getElementById('countTop'), document.getElementById('countSide'), document.getElementById('countBottom')];

    // Results side panel
    const resultsPanel = document.getElementById('resultsPanel');
    const toggleResultsBtn = document.getElementById('toggleResults');
    const resultsList = document.getElementById('resultsList');
    const clearResultsBtn = document.getElementById('clearResults');
    const stoppedCountEls = [document.getElementById('stoppedCount'), document.getElementById('stoppedCount2')];

    // Modal รูป
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const closeModalBtn = document.getElementById('closeModal');

    // Bingo Popup
    const bingoModal = document.getElementById('bingoModal');
    const bingoClose = document.getElementById('bingoClose');
    const bingoTextEl = document.getElementById('bingoText');

    // เติมตัวอักษร B I N G O ! พร้อม index สำหรับ delay
    const letters = ['B','I','N','G','O','!'];
    bingoTextEl.innerHTML = '';
    letters.forEach((ch, i) => {
    const span = document.createElement('span');
    span.className = 'bingo-letter';
      span.style.setProperty('--i', i);   // ใช้กับ animation-delay ใน CSS
  span.textContent = ch;
    bingoTextEl.appendChild(span);
});
    // ===== Shuffle state =====
    let running = false;
    let activeIsA = true;
    let timer = null;
    let lastIndex = -1;
    const TICK_MS = 120;

    // ===== Utils =====
function fmtSize(bytes)
    {
        if (!bytes && bytes !== 0) return '';
        const u=['B','KB','MB','GB']; let i=0, n=bytes;
        while(n>=1024 && i<u.length-1){ n/=1024; i++; }
        return n.toFixed(n<10 && i>0 ? 1 : 0) + ' ' + u[i];
    }
function updateCounters()
    {
        const c = images.length;
        countEls.forEach(el => el.textContent = c);
        startBtn.disabled = c === 0;
    }
function getCurrentShowingSrc()
    {
      if (layerA.classList.contains('active')) return layerA.src || '';
      if (layerB.classList.contains('active')) return layerB.src || '';
      return '';
    }

    // ===== Renderers =====
function renderGallery()
    {
        thumbList.innerHTML = '';
        images.forEach((item, idx) => {
            const row = document.createElement('div'); row.className = 'thumb';
            const im = document.createElement('img'); im.src = item.src;
            const meta = document.createElement('div'); meta.className = 'meta';
            const nm = document.createElement('div'); nm.className = 'name'; nm.textContent = item.name || '(ไม่มีชื่อ)';
            const sz = document.createElement('div'); sz.className = 'size'; sz.textContent = fmtSize(item.size);
                meta.append(nm, sz);
            const del = document.createElement('button'); del.className = 'btn-del'; del.type='button'; del.textContent = 'ลบ';
        del.addEventListener('click', () => removeImageAt(idx));
        row.append(im, meta, del); thumbList.append(row);
      });
      updateCounters();
    }

function renderStopped()
    {
        resultsList.innerHTML = '';
        stoppedCountEls.forEach(el => el.textContent = stoppedImages.length);
        stoppedImages.forEach(obj => {
        const cell = document.createElement('div'); cell.className = 'item';
        const im = document.createElement('img'); im.src = obj.src; im.alt = obj.name || 'stopped'; im.title = obj.name || 'stopped';
        im.addEventListener('click', () => showModal(obj.src));
        cell.appendChild(im); resultsList.appendChild(cell);
      });
    }

    // ===== Pool ops =====
function removeImageAt(index)
    {
        if (index < 0 || index >= images.length) return;
            const removed = images.splice(index, 1)[0];
        renderGallery();
        if (images.length === 0){ stop(false); clearStage(); return; }
            const showing = getCurrentShowingSrc();
        if (removed && removed.src && showing === removed.src)
        {
            const nextIdx = Math.floor(Math.random() * images.length);
            const front = activeIsA ? layerA : layerB;
            const back  = activeIsA ? layerB : layerA;
            back.src = images[nextIdx].src; front.classList.remove('active'); back.classList.add('active');
            activeIsA = !activeIsA; lastIndex = nextIdx;
        }
    }

function clearStage()
    {
        layerA.src=''; layerB.src='';
        layerA.classList.remove('active'); layerB.classList.remove('active');
        lastIndex=-1; activeIsA=true;
    }

function randomIndexNotSame(len, prev)
    {
        if(len<=1) return 0;
        let i; do { i=Math.floor(Math.random()*len); } while(i===prev);
        return i;
    }

function showNext()
    {
        if(images.length===0) return;
        const ni = randomIndexNotSame(images.length, lastIndex);
        const ns = images[ni].src;
        const front = activeIsA ? layerA : layerB;
        const back  = activeIsA ? layerB : layerA;
        back.src = ns;
        front.classList.remove('active'); back.classList.add('active');
        activeIsA = !activeIsA; lastIndex = ni;
    }

    // Start / Stop / Reset 
function start()
    {
        // เล่นเสียง(ลูป)
        const shuffle = document.getElementById('shuffleSound');
            if (shuffle) 
            {
                shuffle.currentTime = 0;
                shuffle.play().catch(()=>{});
            }
        if (running || images.length===0) return;
        stopBtn.classList.add('stop-highlight');

        const current = getCurrentShowingSrc();
        const still = images.some(it => it.src === current);
        if(!still) clearStage();

        if(!layerA.src)
        {
            const first = Math.floor(Math.random()*images.length);
            layerA.src = images[first].src;
            layerA.classList.add('active');
            lastIndex = first;
        }

        running = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        timer = setInterval(showNext, TICK_MS);
    }

function stop(showPopup=true){

        const shuffle = document.getElementById('shuffleSound');
        if (shuffle) 
        {
            shuffle.pause();
            shuffle.currentTime = 0;
        }
        // เล่นเสียงตอนหยุด
        const stopSound = document.getElementById('stopSound');
        if (stopSound) 
        {
            stopSound.currentTime = 0;
            stopSound.play().catch(()=>{});
        }
        if (typeof showPopup !== 'boolean') showPopup = true;

        const showingSrc = getCurrentShowingSrc();

        if (!running)
        {
            if (showingSrc)
            {
            pushStopped(showingSrc);
            if (showPopup) showModal(showingSrc);
            }
        return;
        }

        clearInterval(timer); timer=null; running=false;
        startBtn.disabled = images.length === 0;
        stopBtn.disabled = true;
        stopBtn.classList.remove('stop-highlight');

        const idx = images.findIndex(it => it.src === showingSrc);
        if (idx !== -1){ images.splice(idx,1); renderGallery(); }

        if (showingSrc)
        {
            pushStopped(showingSrc);
        if (showPopup) showModal(showingSrc);
        }

        if (images.length===0){ clearStage(); startBtn.disabled=true; }
    }

function pushStopped(src)
    {
        stoppedImages.unshift({ src, ts: Date.now() });
        renderStopped();
    }

function resetAll()
    {
        // 1) หยุดเสียง (กันค้าง)
        const shuffle = document.getElementById('shuffleSound');
        if (shuffle) { shuffle.pause(); shuffle.currentTime = 0; }
        const stopSound = document.getElementById('stopSound');
        if (stopSound) { stopSound.pause(); stopSound.currentTime = 0; }

        // 2) คืนรูปทั้งหมดเข้าพูล
        images = [...allImages];
        renderGallery();

        // 3) ล้างประวัติ "ผลที่หยุด"
        stoppedImages = [];
        renderStopped();

        // 4) สุ่มโชว์รูป 1 รูปบนเวทีทันที
        if (images.length > 0)
        {
            const i = Math.floor(Math.random() * images.length);
            layerA.src = images[i].src;
            layerA.classList.add('active');
            layerB.classList.remove('active');
            activeIsA = true;
            lastIndex = i;

        startBtn.disabled = false;
        stopBtn.disabled = true;
        } 
        else 
        {
            // ถ้าไม่มีรูปในพูลจริง ๆ ถึงจะ clear stage
            clearStage();
            startBtn.disabled = true;
            stopBtn.disabled = true;
        }

        // 5) ปิด modal ถ้ายังเปิดอยู่
        if (modal.classList.contains('show'))
        {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden','true');
            modalImg.src = '';
        }
    }
    

// เพิ่มรูปจากไฟล์ที่เลือกหรือวาง
function addImagesFromFiles(fileList){
        const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
        if(files.length===0) return;

        files.forEach
        (
            f => 
        {
        const r = new FileReader();
        r.onload = ev => 
        {
            const obj = { src: ev.target.result, name: f.name, size: f.size };
            images.push(obj);
            allImages.push(obj);
            renderGallery();
            startBtn.disabled = false;

            // โชว์รูปแรกสุดที่ใส่ทันที (ครั้งแรกเท่านั้น)
            if (!layerA.src && images.length === 1)
            {
                layerA.src = obj.src;
                layerA.classList.add('active');
                lastIndex = 0;
            }
        };
        r.readAsDataURL(f);
        }
        );
    }

fileInput.addEventListener('change', e => addImagesFromFiles(e.target.files));
    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter','dragover'].forEach(evt => {
        dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'), false);
    });
    ['dragleave','drop'].forEach(evt => {
        dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'), false);
    });
        dropzone.addEventListener('drop', e => addImagesFromFiles(e.dataTransfer.files));

    // Toggles
    toggleSidebarBtn.addEventListener('click', () => sidebar.classList.toggle('hidden'));
    toggleResultsBtn.addEventListener('click', () => resultsPanel.classList.toggle('show'));
    clearResultsBtn.addEventListener('click', () => { stoppedImages = []; renderStopped(); });

    // Modal (รูป) 
    function showModal(src)
    {
        modalImg.src = src;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden','false');
    }
    function hideModal()
    {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden','true');
        modalImg.src = '';

        // หยุดเสียง stopSound 
         const stopSound = document.getElementById('stopSound');
        if (stopSound) 
        {
            stopSound.pause();
            stopSound.currentTime = 0;
        }
    }
    closeModalBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) hideModal(); });
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') hideModal(); });

    // Bingo Popup (ตัวอักษรขึ้นทีละตัว + confetti) 
function openBingo()
    {
         // เล่นเสียง Bingo
        const audio = document.getElementById('bingoSound');
        audio.currentTime = 0;
        audio.play();
        // ล้างตัวอักษร & confetti เก่าถ้ามี
        bingoTextEl.innerHTML = '';
        [...bingoModal.querySelectorAll('.confetti')].forEach(n => n.remove());

        // เติมตัวอักษร B I N G O ! พร้อม delay ไล่ทีละตัว
        const letters = ['B','I','N','G','O','!'];
        letters.forEach
        (
            (ch, i) => 
            {
                const span = document.createElement('span');
                span.className = 'bingo-letter';
                span.style.animationDelay = `${i * 0.15}s`;
                span.textContent = ch;
                bingoTextEl.appendChild(span);
            }
        );

        // สร้าง confetti แบบสุ่มจำนวน N ชิ้น
        const N = 90;
        const colors = ['#ff3b30','#ffcc00','#34c759','#0fb','DodgerBlue','#af52de','#ff9f0a','#ff375f'];
        for(let i=0;i<N;i++)
        {
            const c = document.createElement('div');
            c.className = 'confetti';
            const size = Math.random()*8 + 6; // 6–14 px
            const left = Math.random()*100;   // 0–100 vw (อิงทั้ง viewport)
            const delay = Math.random()*250;  // 0–250 ms
            const dur = Math.random()*1200 + 1400; // 1.4–2.6 s
            const rotDur = Math.random()*1200 + 1000;
            const color = colors[Math.floor(Math.random()*colors.length)];

            c.style.left = left + 'vw';
            c.style.background = color;
            c.style.width = size + 'px';
            c.style.height = (size*1.3) + 'px';
            c.style.opacity = (0.75 + Math.random()*0.25).toFixed(2);
            c.style.animationDuration = `${dur}ms, ${rotDur}ms`;
            c.style.animationDelay = `${delay}ms, ${delay}ms`;

        bingoModal.appendChild(c);
        }

        bingoModal.classList.add('show');
        bingoModal.setAttribute('aria-hidden','false');
    }

        function closeBingo()
        {
            bingoModal.classList.remove('show');
            bingoModal.setAttribute('aria-hidden','true');
            bingoTextEl.innerHTML = '';
            [...bingoModal.querySelectorAll('.confetti')].forEach(n => n.remove());
        }

    // ปุ่ม Bingo / ปิด / คลิกนอกเพื่อปิด / ESC เพื่อปิด
    bingoBtn.addEventListener('click', openBingo);
    bingoClose.addEventListener('click', (e)=>{ e.stopPropagation(); closeBingo(); });
    bingoModal.addEventListener('click', (e)=>{ if(e.target === bingoModal) closeBingo(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeBingo(); });

    // ===== ปุ่มหลัก =====
    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    resetBtn.addEventListener('click', (e) => { e.preventDefault(); resetAll(); });

    // ===== Init =====
    renderGallery();
    renderStopped();
  </script>
</body>
</html>

